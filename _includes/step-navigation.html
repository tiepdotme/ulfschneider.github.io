{% if page.nostepnav != true and page.categories != empty %}

{% for post in site.posts %}

{% if post.url == page.url %}
{% assign current = post %}
{% assign index = forloop.index %}
{% endif %}

{% if current and current.layout != "gallery" %}

{% unless prev %}
{% for p in site.posts offset:index   %}
{% unless prev %}
{% if p.categories != empty and current.categories != empty and p.categories == current.categories %}
{% assign prev = p %}
{% endif %}
{% endunless %}
{% endfor %}
{% endunless %}

{% unless next %}
{% for p in site.posts %}
{% if p.categories != empty and current.categories != empty and p.categories == current.categories and forloop.index < index %}
{% assign next = p %}
{% endif %}
{% endfor %}
{% endunless %}

{% break %}
{% endif %}

{% endfor %}
{% endif %}
{% if prev or next %}

<nav class="clearfix step-navigation small lh-2">
    {% if next  %}
    <div class="float-left mrr nowrap truncate">
        <a class="no-deco meta" accesskey="+" href="{{ site.url }}{{ next.url }}">
            {% if include.shortNav %}
            <div>←</div>
            {% else %}
            <div>Newer</div>
            <div>{% if next.title != "notitle" && next.notitle != true %}
                {{ next.title }}{% endif %}</div>
            {% endif %}
        </a>
    </div>
    {% endif %}

    {% if prev  %}
    <div class="float-right nowrap truncate">
        <a class="no-deco meta" accesskey="-" href="{{ site.url }}{{ prev.url }}">
            {% if include.shortNav %}
            <span>→</span>
            {% else %}
            <div class="right">Older</div>
            <div>{% if prev.title != "notitle" && prev.notitle != true %}
                {{ prev.title }}{% endif %}</div>
            {% endif %}
        </a>
    </div>
    {% endif %}
</nav>
{% endif %}