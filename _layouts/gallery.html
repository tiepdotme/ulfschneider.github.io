<!DOCTYPE html>
<html lang="en">

{% include head.html %}

<script src="/r/jquery.min.js"></script>

<body>
  {% unless page.autoplay %}
  <!-- grid -->
  <div class="grid-gallery-content">

    {% include header.html %}

    <div class="page-content">
      <div class="wrapper">
        {% include title.html %}
        {{ content }}
      </div>
    </div>

    <p style="text-align:center;">
      <a id="displaySlides" style="cursor:pointer;" onclick="displaySlides();">display slides</a>
    </p>

    <ul class="image-grid" id="image-grid">

      {% assign images = "" | split:"|"  %}
      {% for tag in page.tags %}
      {% for post in site.tags.[tag] %}
      {% unless post.nonav %}
      {% if post.layout contains 'image' and post.thumburl %}
      {% assign images = images | push: post %}
      {% endif %}
      {% endunless %}
      {% endfor %}
      {% endfor %}
      {% if page.reversed %}
      {% assign sorted-images = images | sort:'date' %}
      {% else %}
      {% assign sorted-images = images %}
      {% endif %}

      {% for image in sorted-images %}

      <a href="{{ image.url | prepend: site.baseurl }}">
        <li class="image-grid">
          <div class="image">
            <img src="{{image.thumburl | prepend: site.baseurl}}"/>
            {% if image.message %}
            <h2>{{image.message}}</h2>
            {% elsif image.abstract %}
            <h2>{{image.abstract}}</h2>
            {% elsif image.title %}
            <h2>{{image.title}}</h2>
            {% endif %}
          </div>
        </li>
      </a>

      {% endfor %}
    </ul>

    <script src="/r/imagesloaded.min.js"></script>
    <script src="/r/masonry.min.js"></script>

    <script>
    $('.slide-gallery-content').hide();

    container = $('#image-grid')[0];
    masonry = new Masonry(container, {itemSelector: 'li', gutter: 0, percentPosition: true});
    imgLoad = imagesLoaded(container);
    imgLoad.on('progress', function() {
      masonry.layout();
    });

    </script>

    {% unless page.nofooter %}
    {% include footer.html %}
    {% endunless %}

  </div>

  {% endunless %}


  <!-- slides -->
  <div style="display:none;" class="slide-gallery-content">
    <div class="wrapper">

      {% include title.html %}
      {{ content }}

      {% unless page.autoplay %}
      <div class="nav">
        <a class="gallery" id="gallery" onclick="displayGrid();">back to gallery</a>
        <div class="direction">
          <a class="prev" id="prev" onclick="prev();" accesskey="-"><&nbsp;prev</a>
          <a class="next" id="next" onclick="next();" accesskey="+">next&nbsp;></a>
        </div>
      </div>
      {% endunless %}

      <div class="slides" id="slides">

        {% assign images = "" | split:"|"  %}
        {% for tag in page.tags %}
        {% for post in site.tags.[tag] %}
        {% unless post.nonav %}
        {% if post.layout contains 'image' and post.thumburl %}
        {% assign images = images | push: post %}
        {% endif %}
        {% endunless %}
        {% endfor %}
        {% endfor %}
        {% if page.reversed %}
        {% assign sorted-images = images | sort:'date' %}
        {% else %}
        {% assign sorted-images = images %}
        {% endif %}

        {% for image in sorted-images %}
        <div class="slide">
          {% if image.slideurl %}
          <img lazy="{{image.slideurl | prepend: site.baseurl}}"/>
          {% else %}
          <img lazy="{{image.thumburl | prepend: site.baseurl}}"/>
          {% endif %}

          {% if image.message %}
          <h2>  {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.message}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% elsif image.abstract %}
          <h2> {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.abstract}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% elsif image.title %}
          <h2> {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.title}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% endif %}
        </div>

        {% endfor %}

      </div>
    </div>


    {% unless page.autoplay %}
    <script src="/r/jquery.mobile.custom.min.js"></script>
    {% endunless %}


    <script>
    loadingImage = false; //avoid loading of multiple images due to timeout interferences or timeout throttling

    function center() {
      var iwidth = $('.slides > :first-child > img').width();
      var swidth = $('.slides').width();

      if (iwidth && iwidth < swidth) {
        $('.slides > :first-child').css('width', iwidth).css('margin-left', (swidth - iwidth) / 2);
        $('.slides > :first-child > img').css('margin-left', 0).css('margin-right', 0);
      }
    }

    function adjustHeight() {
      var height = $('.slides > :first-child').height();
      var minHeight = parseInt($('.slides').css('min-height'));      
      $('.slides').css('min-height', Math.max(height, minHeight));
    }

    function displayImage() {

      var slide = $('.slides > :first-child');
      var img = $('.slides > :first-child > img[lazy]');

      if (img.attr('loaded') !== 'true') {
        slide.hide(0);
        img.attr('src', img.attr('lazy'));
      } else {
        slide.fadeIn();
        adjustHeight();
        center();
      }

      //autoplay
      {% if page.autoplay %}
      if (!loadingImage) {
        loadingImage = true;
        if (img.attr('loaded') === 'true') {
          setTimeout(next, 3000);
        } else {
          img.on('load', function() {
            img.attr('loaded', 'true');
            slide.fadeIn();
            adjustHeight();
            center();
            setTimeout(next, 3000);
          });
        }
      }
      {% else %}
      //non autoplay
      img.on('load', function() {
        img.attr('loaded', 'true');
        slide.fadeIn();
        adjustHeight();
        center();
      });
      {% endif %}

    }


    function next() {
      loadingImage = false;
      $('.slides > :first-child').fadeOut().next().end().appendTo('.slides');
      displayImage();
    }

    function prev() {
      loadingImage = false;
      $('.slides > :first-child').fadeOut();
      $('.slides > :last-child').insertBefore('.slides > :first-child');
      displayImage();
    }

    function displayGrid() {
      $('.slide-gallery-content').fadeOut();
      $('.grid-gallery-content').delay(500).fadeIn();
      masonry.layout();
    }

    function displaySlides() {
      $('.grid-gallery-content').fadeOut();
      $('.slide-gallery-content').delay(500).fadeIn();

      setTimeout(displayImage, 510);
    }


    {% unless page.autoplay %}

    $("body").keydown(function (e) {
      if (e.which === 37) {
        prev();
      }
      else if (e.which === 39) {
        next();
      }
      else if (e.which === 27) {
        displayGrid();
      }
    });

    $(".slide").on("swipeleft", next);
    $(".slide").on("swiperight", prev);
    {% endunless %}

    $(function () {
      $('.slides > :gt(0)').hide();
    });
    </script>
  </div>

  {% if page.autoplay %}
  <script>
  displaySlides();
  </script>
  {% endif %}


  {% include footer_scripts.html %}
</body>

</html>
