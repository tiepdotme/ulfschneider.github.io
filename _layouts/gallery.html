<!DOCTYPE html>
<html lang="en">

{% include head.html %}

<script src="/r/jquery.min.js"></script>

<body>

  {% unless page.autoplay %}
  <!-- grid -->
  <div class="grid-gallery-content">

    {% include header.html %}

    <div class="page-content">
      <div class="wrapper">
        {% include title.html %}
        {{ content }}
      </div>
    </div>

    {% unless page.noslides %}
    <p style="text-align:center;">
      <a id="displaySlides" style="cursor:pointer;" onclick="displaySlides();">display slides</a>
    </p>
    {% endunless %}

    <ul class="image-grid" id="image-grid">
      {% assign images = "" | split:"|"  %}
      {% for tag in page.tags %}
      {% for p in site.tags.[tag] %}
      {% unless p.nonav %}
      {% if p.layout contains 'image' and p.thumburl %}      
      {% assign images = images | push: p %}
      {% endif %}      
      {% endunless %}
      {% endfor %}
      {% endfor %}
      {% if page.reversed %}
      {% assign sorted-images = images | sort:'date' %}
      {% else %}
      {% assign sorted-images = images %}
      {% endif %}
      {% for image in sorted-images %}<li class="image-grid"><!-- use this weird way of writing the <li> tags to get rid of the tiny column gap between images -->
      <a href="{{ image.url | prepend: site.baseurl }}">
        <div class="image">
          <img src="{{image.thumburl | prepend: site.baseurl}}"/>
          {% if image.message %}
          <h2>{{image.message}}</h2>
          {% elsif image.abstract %}
          <h2>{{image.abstract}}</h2>
          {% elsif image.title %}
          <h2>{{image.title}}</h2>
          {% endif %}
        </div>
      </a>
    </li>{% endfor %}</ul>

    <script>
      $('.slide-gallery-content').hide();
    </script>

  </div>

  {% endunless %}

  <!-- slides -->
  {%unless page.noslides %}
  <div style="display:none;" class="slide-gallery-content">
    <div class="wrapper">

      {% include title.html %}
      {{ content }}

      {% unless page.autoplay %}
      <div class="nav">
        <a class="gallery" id="gallery" onclick="displayGrid();">back to gallery</a>
        <div class="direction">
          <a class="prev" id="prev" onclick="prev();" accesskey="-"><&nbsp;prev</a>
          <a class="next" id="next" onclick="next();" accesskey="+">next&nbsp;></a>
        </div>
      </div>
      {% endunless %}

      <div class="slides" id="slides">

        {% assign images = "" | split:"|"  %}
        {% for tag in page.tags %}
        {% for p in site.tags.[tag] %}
        {% unless p.nonav %}
        {% if p.layout contains 'image' and p.thumburl %}
        {% assign images = images | push: p %}
        {% endif %}
        {% endunless %}
        {% endfor %}
        {% endfor %}
        {% if page.reversed %}
        {% assign sorted-images = images | sort:'date' %}
        {% else %}
        {% assign sorted-images = images %}
        {% endif %}

        {% for image in sorted-images %}
        <div class="slide">
          {% if image.slideurl %}
          <img lazy="{{image.slideurl | prepend: site.baseurl}}"/>
          {% else %}
          <img lazy="{{image.thumburl | prepend: site.baseurl}}"/>
          {% endif %}

          {% if image.message %}
          <h2>  {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.message}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% elsif image.abstract %}
          <h2> {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.abstract}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% elsif image.title %}
          <h2> {% unless page.autoplay %}<a href="{{ image.url | prepend: site.baseurl }}">{% endunless %}{{image.title}} {% unless page.autoplay %}</a>{% endunless %}</h2>
          {% endif %}
        </div>

        {% endfor %}

      </div>
    </div>


    {% unless page.autoplay %}
    <script src="/r/jquery.mobile.custom.min.js"></script>
    {% endunless %}


    <script>
    loadingImage = false; //avoid loading of multiple images due to timeout interferences or timeout throttling

    function center() {
      var iwidth = $('.slides > :first-child > img').width();
      var swidth = $('.slides').width();

      if (iwidth && iwidth < swidth) {
        $('.slides > :first-child').css('width', iwidth).css('margin-left', (swidth - iwidth) / 2);
        $('.slides > :first-child > img').css('margin-left', 0).css('margin-right', 0);
      }
    }

    function adjustHeight() {
      var height = $('.slides > :first-child').outerHeight();
      var minHeight = parseInt($('.slides').css('min-height'));      
      $('.slides').css('min-height', Math.max(height, minHeight));
    }

    function displayImage() {
      var slide = $('.slides > :first-child');
      var img = $('.slides > :first-child > img[lazy]');

      if (img.attr('loaded') !== 'true') {
        slide.hide(0);
        img.attr('src', img.attr('lazy'));
        $('.slides').prepend('<div id="loading">loading ...</div>');
        $('#loading').delay(500).show(0);
      } else {
        $('#loading').remove();
        slide.fadeIn(500);
        center();
        adjustHeight();        
      }

      //autoplay
      {% if page.autoplay %}
      if (!loadingImage) {
        loadingImage = true;
        if (img.attr('loaded') === 'true') {
          setTimeout(next, 4000);
        } else {
          img.on('load', function() {
            img.attr('loaded', 'true');
            $('#loading').remove();
            slide.fadeIn(500);
            center();            
            adjustHeight();
            setTimeout(next, 4000);
          });
        }
      }
      {% else %}
      //non autoplay
      img.on('load', function() {
        img.attr('loaded', 'true');
        $('#loading').remove();
        slide.fadeIn(500);
        center();        
        adjustHeight();
      });
      {% endif %}

    }


    function next() {
      loadingImage = false;
      $('.slides > :first-child').fadeOut(500).next().end().appendTo('.slides');
      displayImage();
    }

    function prev() {
      loadingImage = false;
      $('.slides > :first-child').fadeOut(500);
      $('.slides > :last-child').insertBefore('.slides > :first-child');
      displayImage();
    }

    function displayGrid() {
      $('.slide-gallery-content').hide(0);
      $('.grid-gallery-content').show(0);
    }

    function displaySlides() {      
      $('.grid-gallery-content').hide(0);
      $('.slide-gallery-content').show(0);
      displayImage();      
    }


    {% unless page.autoplay %}

    $("body").keydown(function (e) {
      if (e.which === 37) {
        prev();
      }
      else if (e.which === 39) {
        next();
      }
      else if (e.which === 27) {
        displayGrid();
      }
    });

    $(".slide").on("swipeleft", next);
    $(".slide").on("swiperight", prev);
    {% endunless %}

    $(function () {
      $('.slides > :gt(0)').hide(0);
    });
  </script>
</div>

{% if page.autoplay %}
<script>
  displaySlides();
</script>
{% endif %}
{% endunless %}

{% unless page.nofooter %}
{% include footer.html %}
{% endunless %}

{% include footer_scripts.html %}
</body>

</html>
