{%- assign contentNodes = site.posts -%}
{%- assign contentNodes = contentNodes | concat: site.pages -%}
{%- assign pageMeta = "" | split: "" -%}
{%- assign pageMeta = pageMeta | push: page.tags -%}
{%- assign pageMeta = pageMeta | push: page.categories -%}
{%- assign pageMeta = pageMeta | uniq -%}

<script src="https://unpkg.com/lunr/lunr.js"></script>
<script>
    const SEARCH_RESULTS_ID = 'search-results';
    const SEARCH_QUERY_ID = 'search-query';

    var searchData = [
        {% - for meta in pageMeta -%}
    {% - for node in contentNodes -%}
    {% - if node.published != false and node.nosearch != true -%}
    {% - if meta == "." or node.tags contains meta or node.categories contains meta -%}
    {
        'id': { { node.url | jsonify } },
        'title': {%if node.title %} { { node.title | jsonify } } {% else %} { { node.topnav | jsonify } } {% endif %},
        'excerpt': { { node.content | strip_html | truncatewords: 25, "&nbsp;…" | jsonify } },
        'date': { { node.date | jsonify } },
        'author': { { node.author | jsonify } },
        'categories': { { node.categories | jsonify } },
        'tags': { { node.tags | jsonify } },
        'content': { { node.content | strip_html | jsonify } }
    } ,
    {% - endif -%}
    {% - endif -%}
    {% - endfor -%}
    {% - endfor -%}
];

    var searchIndex;
    var friendlyMap = new Map();
    function buildSearchIndex() {
        return lunr(function () {
            this.ref('id');
            this.field('title', { boost: 10 });
            this.field('author');
            this.field('categories');
            this.field('tags');
            this.field('content');

            for (let data of searchData) {
                this.add(data);
                friendlyMap.set(data.id, { title: data.title, excerpt: data.excerpt, author: data.author, date: data.date, categories: data.categories, tags: data.tags });
            }
        });
    }

    function getParameterByName(name, url) {
        url = url ? url : window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        let results = regex.exec(url);
        if (!results) {
            return null;
        }
        if (!results[2]) {
            return '';
        }
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function removeChildren(parent) {
        if (parent) {
            let child = parent.lastElementChild;
            while (child) {
                parent.removeChild(child);
                child = parent.lastElementChild;
            }
        }
    }

    function printResultEntry(parent, entry) {
        if (parent) {
            let friend = friendlyMap.get(entry.ref);

            let article = document.createElement('article');
            article.classList = 'mry-1';
            parent.appendChild(article);

            let title = document.createElement('h2');
            title.className = 'mry-0'
            article.appendChild(title);

            let anchor = document.createElement('a');
            anchor.href = entry.ref;
            if (friend.title && friend.title != 'notitle') {
                anchor.innerHTML = friend.title;
            } else {
                anchor.innerHTML = 'Without Title';
            }
            anchor.className = "no-deco";
            title.appendChild(anchor);

            let aside = document.createElement('aside');
            aside.classList = "meta small";
            article.appendChild(aside);

            if (friend.author) {
                let author = document.createElement('span');
                author.innerHTML = 'by ' + friend.author;
                aside.appendChild(author);
            }

            if (friend.author && friend.date) {
                let on = document.createElement('span');
                on.innerHTML = ' on ';
                aside.appendChild(on);
            }

            if (friend.date) {
                let date = document.createElement('span');
                aside.appendChild(date);
                let dateParts = friend.date.split(' ');
                let dateString = dateParts[0];
                dateString += 'T';
                dateString += dateParts[1];
                dateString += dateParts[2].substring(0, 3);
                dateString += ':';
                dateString += dateParts[2].substring(3);
                date.innerHTML = (new Date(dateString)).toDateString();
            }

            if (friend.excerpt) {
                let excerpt = document.createElement('p');
                article.appendChild(excerpt);
                excerpt.innerHTML = friend.excerpt;
            }

            let cont = document.createElement('a');
            article.appendChild(cont);
            cont.href = entry.ref;
            cont.classList = 'small meta inline-block';
            cont.innerHTML = 'Continue reading →';

        }
    }

    function printHeading(resultSet, query) {
        let heading = document.getElementsByTagName('h1');
        if (heading.length) {
            if (resultSet.length) {
                heading[0].innerHTML = 'Search results for "' + query + '"';
            } else {
                heading[0].innerHTML = 'No search results for "' + query + '"';
            }
        }
    }

    function printResultCount(searchResults, resultSet, query) {
        let count = document.createElement('p');
        if (resultSet.length == 0) {
            count.innerHTML = 'Your search for "' + query + '" did not return any results.'
        } else {
            count.innerHTML = resultSet.length + ' results:';
        }
        count.classList = "small meta mry no-indent";
        searchResults.append(count);
    }

    function printSearchResults(resultSet, query) {
        let searchResults = document.getElementById(SEARCH_RESULTS_ID);
        if (!searchResults) {
            console.error('The page does not have a DOM element with id=' + SEARCH_RESULTS_ID);
            return;
        }
        removeChildren(searchResults);
        printHeading(resultSet, query);
        printResultCount(searchResults, resultSet, query);
        if (resultSet.length) {
            for (let entry of resultSet) {
                printResultEntry(searchResults, entry);
            }
        }
    }

    function search(query) {
        let resultSet = [];
        if (query && query.trim().length) {
            resultSet = searchIndex.search(query);
        }
        printSearchResults(resultSet, query);
    }

    window.addEventListener('load', function (event) {
        searchIndex = buildSearchIndex();
        let query = getParameterByName('query');
        let input = document.getElementById(SEARCH_QUERY_ID);
        if (input) {
            input.value = query;
        }

        if (query) {
            search(query);
        }
    }); 
</script>

<div>
    <form class="flex mxw-sm" onsubmit="event.preventDefault(); search(event.target[SEARCH_QUERY_ID].value);">
        <input id="search-query" class="bold width-100 mrr-d3" type="text" />
        <input type="submit" class="button" value="Search" />
    </form>
</div>
<div id="search-results"></div>

<!--
To Do to complete:

- Format the search result
- Provide an input field that can be used on any page
- Use a git commit hook to create the search search index 
- When searching, request that index with a javascript get request
- Create the index on the client only as a fallback solution
-->